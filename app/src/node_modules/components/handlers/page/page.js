var React       = require('react')
var Fluxxor     = require('fluxxor')
var StoreWatchMixin = Fluxxor.StoreWatchMixin

var Load        = require('components/load')
var ArticlesList        = require('./articles')
var TermsList        = require('./terms')

var NavBack            = require('components/nav-back')

var Grid 				= require('react-bootstrap/lib/Grid')
var Row 				= require('react-bootstrap/lib/Row')
var Col 				= require('react-bootstrap/lib/Col')
var NavPrimary  = require('components/nav-primary')

var _           = require('lodash')
var marked               = require('utils/parse-markdown')

var log       = require('debug')('src:components:page')

module.exports = React.createClass({
mixins: [
    Fluxxor.FluxMixin(React),
    StoreWatchMixin('pages')
  ],

  getStateFromFlux: function () {
    var flux = this.getFlux()    
    return {
      loading: flux.store('pages').isLoading()
    }
  },

   render: function () {
    var flux = this.getFlux()    
    
    if (this.state.loading ) {
      return  (<Load />)
    } else {
      var pageid = this.props.params.id
      var page = flux.stores.pages.findOne({ id: pageid })
      if (typeof page !== 'undefined') {
        return (
        <div className="page-wrapper">      
          <div className={"page-content page-content-"+pageid}>        
            {this.renderMain(page)}
            { (page.entities !== '') 
              ? this.renderEntities(page)
              : null }
          </div>
        </div>
        )
      } else {
        return (
          <div className="page-wrapper">      
            <div className="page-content">        
              <Grid className='page-section'>
                <Row>
                  <Col md={9} xs={9}>
                    <div className='page-title'>
                      <h2>Page not found</h2>
                    </div>
                  </Col>
                </Row>
              </Grid>
            </div>
          </div>
        )

      }
    }
  },
  renderMain : function(page) {
    return (
      <Grid className='page-section'>
        <div className='nav-control'>
          <NavBack/>    
        </div>          
        <Row>
          <Col md={9} xs={9}>
            <div className='page-title'>
              <h2>{page.title}</h2>      
            </div>
            <h3 className='page-lead-header'>{page.lead}</h3>
            <div className='marked-inner-html'
              dangerouslySetInnerHTML={{
                __html: marked(page.description, {sanitize: true})
              }} >
            </div>  
          </Col>
        </Row>
      </Grid>     
    )
  },
  renderEntities : function(page) {
    
    if (page.entities === 'terms') {
     
      return (
        <Grid className='page-section page-section-entities'>
          <Row>
            <Col md={12} xs={12}>
              <TermsList />              
            </Col>
          </Row>
        </Grid>     
      )
    }     
    else if (page.entities === 'articles') {
     
      return (
        <Grid className='page-section page-section-entities'>
          <Row>
            <Col md={12} xs={12}>
              <ArticlesList />              
            </Col>
          </Row>
        </Grid>     
      )
    }     
  }
  
})
